var e=Object.defineProperty,t=(t,s,n)=>((t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n)(t,"symbol"!=typeof s?s+"":s,n);import{r as s}from"./phaser-UvlxNa5i.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var n=s();class o extends n.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}class i extends n.Scene{constructor(){super("GameOver"),t(this,"camera"),t(this,"background"),t(this,"gameover_text")}create(){this.camera=this.cameras.main,this.camera.setBackgroundColor(16711680),this.background=this.add.image(512,384,"background"),this.background.setAlpha(.5),this.gameover_text=this.add.text(512,384,"Game Over",{fontFamily:"Arial Black",fontSize:64,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}),this.gameover_text.setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("MainMenu")}))}}const a=2048,r=1536,p=1094.4;class c{constructor(){t(this,"_models"),this._models={}}}class l extends c{}class h extends l{buildUi({scene:e}){const t=e.matter.add.image(400,p,"saw").setCircle(60).setBounce(.4);return t.setFrictionAir(.03),t.setScale(.5),t}}class m extends l{buildUi({scene:e}){const t=e.cache.json.get("castles"),s=[];for(const n of t){const t=e.matter.add.image(1433.6+n.x,1254.4+n.y,"brick_tile",void 0,{label:"block"}).setBody({type:"rectangle",width:48,height:16});t.rotation=n.rotation,console.log(t.y),s.push(t)}return s}}class d extends l{buildUi({scene:e}){const t=e.add.image(1024,768,"gameBg");return t.setScale(2),t.setOrigin(.5),t}}class _ extends l{buildUi({scene:e}){const t=e.add.tileSprite(1024,1318.4,4096,128,"bgTile");return t.setOrigin(.5),e.matter.add.gameObject(t,{isStatic:!0,label:"ground"}),console.log("ground",t.y-t.height/2),t}}class u extends l{buildUi({scene:e}){return e.matter.add.image(400,p,"slingshot_bottom","",{isStatic:!0,isSensor:!0,render:{visible:!0}})}}class g extends c{buildUi(e){const{scene:t}=e,s=new _,n=new h,o=new u,i=new m;return{bg:(new d).buildUi({scene:t}),ground:s.buildUi({scene:t}),bullet:n.buildUi({scene:t}),slingshotPoint:o.buildUi({scene:t}),bricks:i.buildUi({scene:t})}}}const S="COMPLETE";class C{constructor(){t(this,"completeStepSignal",new Phaser.Events.EventEmitter),t(this,"_params"),t(this,"_models"),this._models={}}_onComplete(...e){console.log("complete",this),this.completeStepSignal.emit(S,...e)}forceComplete(){}}class w extends C{}class f{constructor(){t(this,"completeSteps",new Phaser.Events.EventEmitter),t(this,"_sequences"),t(this,"_stepByStepSteps",[]),t(this,"_awaitSteps",[]),t(this,"_permanentsSteps",[]),t(this,"_dynamicSteps",new Set),t(this,"_numPermanentsSteps",0),t(this,"_numConsequentsSteps",0),t(this,"_isForceComplete",!1)}start(e){this._isForceComplete=!1,this._dynamicSteps.clear(),this._sequences=e,this._playNextSequence()}addDynamicStep(e,t){this._dynamicSteps.add(e),console.log("start",e),e.completeStepSignal.once(S,this._onCompleteDynamicStep,this),e.start(t)}_onCompleteDynamicStep(e){this._dynamicSteps.has(e)&&this._dynamicSteps.delete(e)}_playNextSequence(){const e=this._sequences;if(e&&e.length>0){const e=this._sequences.shift();this._setUpSequence(e)}else this._onComplete()}_setUpSequence(e){this._numPermanentsSteps=0,this._stepByStepSteps=e.stepByStep,this._permanentsSteps=e.permanents,this._awaitSteps=e.awaitSteps,this._numConsequentsSteps=e.stepByStep.length,e.permanents.length>0&&this._setUpPermanentsSteps(e.permanents),e.awaitSteps.length>0&&this._setUpAwaitSteps(e.awaitSteps),this._playNextConsequentStep()}_setUpPermanentsSteps(e){for(let t=0;t<e.length;t++){this._numPermanentsSteps++;const s=e[t].step,n=e[t].params;console.log("start",s),s.completeStepSignal.once(S,this._onPermanentStepComplete,this),s.start(n)}}_setUpAwaitSteps(e){for(let t=0;t<e.length;t++){const s=e[t].step,n=e[t].params;console.log("start",s),s.start(n)}}_onPermanentStepComplete(){this._numPermanentsSteps--,0===this._numPermanentsSteps&&this._tryCompleteSequence()}_playNextConsequentStep(){const e=this._stepByStepSteps;if(this._numConsequentsSteps>0){const t=e.length-this._numConsequentsSteps,s=e[t].step,n=e[t].params;console.log("start",s),s.completeStepSignal.once(S,this._onConsequentStepComplete,this),s.start(n)}else this._completeAwaitSteps(),this._tryCompleteSequence()}_completeAwaitSteps(){for(const{step:e}of this._awaitSteps)e.forceComplete();this._awaitSteps=[]}_onConsequentStepComplete(){this._isForceComplete||(this._numConsequentsSteps--,this._playNextConsequentStep())}_tryCompleteSequence(){this._isForceComplete||0===this._numPermanentsSteps&&0===this._numConsequentsSteps&&this._playNextSequence()}_onComplete(){this._sequences=[],this._stepByStepSteps=[],this._permanentsSteps=[],this._awaitSteps=[];for(const e of this._dynamicSteps)e.completeStepSignal.removeAllListeners(),e.forceComplete();this._dynamicSteps.clear(),this.completeSteps.emit(S)}forceComplete(){this._isForceComplete=!0;for(const e of this._stepByStepSteps)e.step.completeStepSignal.removeAllListeners(),e.step.forceComplete();for(const e of this._permanentsSteps)e.step.completeStepSignal.removeAllListeners(),e.step.forceComplete();for(const e of this._awaitSteps)e.step.completeStepSignal.removeAllListeners(),e.step.forceComplete();this._onComplete()}}class y extends C{constructor(){super(),t(this,"_mng",new f),this._mng.completeSteps.on(S,this._onComplete,this)}}class b{constructor(){t(this,"permanents",[]),t(this,"awaitSteps",[]),t(this,"stepByStep",[])}addPermanent(e,t){this.permanents.push({step:e,params:t})}addAwaitPermanentStep(e,t){this.awaitSteps.push({step:e,params:t})}addStepByStep(e,t){this.stepByStep.push({step:e,params:t})}}class P extends C{start(e){this._params=e;const{scene:t,delay:s}=e;t.time.delayedCall(s,this._onComplete,void 0,this)}}class x extends C{start(e){this._params=e;const{scene:t}=e;t.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){const{bullet:e,constraintComponent:t}=this._params,s=t.getPosition();e.setPosition(s.x,s.y)}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),this._worldUpdate(),super._onComplete()}forceComplete(){this._onComplete()}}class k extends C{start(e){this._params=e;const{scene:t}=e;t.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){const e=this._params.scene.matter.world.localWorld.bodies;let t=!1;for(const s of e)s.speed>.2&&(t=!0);t||this._onComplete()}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),super._onComplete()}}class U extends C{start(e){this._params=e;const{bullet:t,scene:s,duration:n}=e;s.camera.once("camerazoomcomplete",this._onComplete,this),s.camera.pan(t.x,t.y,n,"Sine.easeInOut"),s.zoomTo(1.2,n,"Sine.easeInOut")}_onComplete(){const{bullet:e,scene:t}=this._params;e.setAngularVelocity(-.5),t.camera.off("camerazoomcomplete",this._onComplete,this),t.camera.startFollow(e,!0,.1,.1),super._onComplete()}}class v extends C{start(e){this._params=e;const{bullet:t,scene:s}=e;t.setPosition(400,p),s.camera.stopFollow(),s.camera.once("camerazoomcomplete",this._onComplete,this),s.camera.pan(1024,768,500,"Sine.easeInOut"),s.zoomTo(1,500,"Sine.easeInOut")}_onComplete(){const{scene:e}=this._params;e.camera.off("camerazoomcomplete",this._onComplete,this),e.camera.centerOn(1024,768),super._onComplete()}}class B extends C{start(e){this._params=e;const{scene:t,constraintComponent:s}=e;e.scene.matter.world.removeConstraint(s.constraint),t.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){this._params.bullet.body.speed&&this._params.bullet.body.speed>0&&this._onComplete()}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),super._onComplete()}}class q extends y{constructor(){super(...arguments),t(this,"_resetBulletStep",new v),t(this,"_endStrikeStep",new k),t(this,"_startStrikeStep",new B),t(this,"_awaitStep",new P),t(this,"_preparationStrikeStep",new U),t(this,"_awaitStrikeStep",new x)}start({gameView:e,scene:t,constraintComponent:s}){const n=new b;n.addAwaitPermanentStep(this._awaitStrikeStep,{scene:t,bullet:e.bullet,constraintComponent:s}),n.addStepByStep(this._preparationStrikeStep,{scene:t,bullet:e.bullet,duration:1e3});const o=new b;o.addStepByStep(this._startStrikeStep,{scene:t,bullet:e.bullet,constraintComponent:s}),o.addStepByStep(this._endStrikeStep,{scene:t}),o.addStepByStep(this._awaitStep,{scene:t,delay:2e3}),o.addStepByStep(this._resetBulletStep,{bullet:e.bullet,scene:t}),this._mng.start([n,o])}}class A extends C{constructor(){super(...arguments),t(this,"_pointerComponent")}start(e){this._params=e;const{scene:t,pointerComponent:s}=e;this._pointerComponent=s,t.input.on("pointerdown",this._startDrag,this)}_startDrag(e){const t=e.positionToCamera(this._params.scene.cameras.main),s=this._params.bullet;Phaser.Math.Distance.Between(t.x,t.y,s.x,s.y)<100&&(this._pointerComponent.pointer=t,this._pointerComponent.startDrag(),this._onComplete())}_onComplete(){this._params.scene.input.off("pointerdown",this._startDrag,this),super._onComplete()}}class D extends C{constructor(){super(...arguments),t(this,"_pointerComponent")}start(e){this._params=e;const{scene:t,pointerComponent:s}=e;this._pointerComponent=s,t.input.on("pointermove",this._onPointerMove,this),t.matter.world.on("afterupdate",this._onPhysicUpdate,this)}_onComplete(){const e=this._params.scene;e.input.off("pointermove",this._onPointerMove,this),e.matter.world.off("afterupdate",this._onPhysicUpdate,this),super._onComplete()}_onPhysicUpdate(){this._pointerComponent.isDragging&&this._pointerComponent.pointer&&this._onDrag(this._pointerComponent.pointer)}_onPointerMove(e){this._pointerComponent.isDragging&&(this._pointerComponent.pointer=e.positionToCamera(this._params.scene.cameras.main))}_onDrag(e){const t=e,s=this._params.slingshotPoint.body.position,{bullet:n,constraintComponent:o}=this._params;if(Phaser.Math.Distance.Between(s.x,s.y,t.x,t.y)<100)n.setPosition(t.x,t.y),o.setPosition(t.x,t.y);else{const e=Math.atan2(t.y-s.y,t.x-s.x),i=100*Math.sin(e),a=100*Math.cos(e);n.setPosition(s.x+a,s.y+i),o.setPosition(s.x+a,s.y+i)}}forceComplete(){this._onComplete()}}class M extends C{constructor(){super(...arguments),t(this,"_pointerComponent")}start(e){this._params=e;const{scene:t,pointerComponent:s}=e;this._pointerComponent=s,t.input.on("pointerup",this._release,this)}_release(){if(this._pointerComponent.isDragging){const e=this._params.bullet;this._pointerComponent.endDrag(),this._pointerComponent.pointer=void 0;const t=e.body.velocity;e.setVelocity(Phaser.Math.Clamp(t.x,-50,50),Phaser.Math.Clamp(t.y,-50,50)),this._onComplete()}}_onComplete(){this._params.scene.input.off("pointerup",this._release,this),super._onComplete()}}class O extends y{constructor(){super(...arguments),t(this,"_awaitUserActionStep",new A),t(this,"_endDragStep",new M),t(this,"_dragActionStep",new D)}start({gameView:e,pointerComponent:t,constraintComponent:s,scene:n}){const o=new b;o.addStepByStep(this._awaitUserActionStep,{scene:n,bullet:e.bullet,pointerComponent:t});const i=new b;i.addAwaitPermanentStep(this._dragActionStep,{scene:n,bullet:e.bullet,slingshotPoint:e.slingshotPoint,pointerComponent:t,constraintComponent:s}),i.addStepByStep(this._endDragStep,{scene:n,bullet:e.bullet,pointerComponent:t}),this._mng.start([o,i])}}class z extends w{constructor(){super(...arguments),t(this,"_userActionController",new O),t(this,"_strikeController",new q)}start(e){this._params=e;const{gameView:t,pointerComponent:s,scene:n,constraintComponent:o}=e;o.createConstraint(t.bullet.body,t.slingshotPoint,n);const i=this._userActionController;i.completeStepSignal.once(S,this._playStrike,this),i.start({gameView:t,pointerComponent:s,constraintComponent:o,scene:n})}_playStrike(){this._strikeController.completeStepSignal.once(S,this._playResult,this);const{scene:e,gameView:t,constraintComponent:s}=this._params;this._strikeController.start({scene:e,gameView:t,constraintComponent:s})}_playResult(){const{gameView:e,pointerComponent:t,constraintComponent:s,scene:n}=this._params;s.createConstraint(e.bullet.body,e.slingshotPoint,n);const o=this._userActionController;o.completeStepSignal.once(S,this._playStrike,this),o.start({gameView:e,pointerComponent:t,constraintComponent:s,scene:n})}}class E{constructor(){t(this,"pointer"),t(this,"_isDragging",!1)}startDrag(){this._isDragging=!0}endDrag(){this._isDragging=!1}get isDragging(){return this._isDragging}}class N{constructor(){t(this,"_constraint"),t(this,"_pos")}createConstraint(e,t,s){return this._constraint=s.matter.add.constraint(e,t,0,.02),this._constraint}setPosition(e,t){this._pos=new Phaser.Math.Vector2(e,t)}getPosition(){return this._pos}get constraint(){return this._constraint}pauseUpdate(){}}class T extends n.Scene{constructor(){super("Game"),t(this,"camera"),t(this,"_scale",1)}create(){this.camera=this.cameras.main,this.scale.on("resize",this.resize,this),this.resize({width:window.innerWidth,height:window.innerHeight}),this.add.rectangle(0,0,a,r,16777215).setOrigin(0),this._createGame()}_createGame(){this.matter.world.setBounds(0,0,a,r);const e=(new g).buildUi({scene:this}),t=new N,s=new E;(new z).start({gameView:e,pointerComponent:s,constraintComponent:t,scene:this})}resize(e){const{width:t,height:s}=e,n=t,o=s,i=a,p=r,c=this._scale=Math.min(n/i,o/p);this.cameras.main.setZoom(c),this.cameras.main.centerOn(1024,768)}zoomTo(e,t,s){this.camera.zoomTo(this._scale*e,t,s)}}class L extends n.Scene{constructor(){super("MainMenu"),t(this,"background"),t(this,"logo"),t(this,"title")}create(){this.background=this.add.image(512,384,"background"),this.logo=this.add.image(512,300,"logo"),this.title=this.add.text(512,460,"Main Menu",{fontFamily:"Arial Black",fontSize:38,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("Game")}))}}class V extends n.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const e=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",(t=>{e.width=4+460*t}))}preload(){this.load.json("castles","data/castles.json"),this.load.setPath("assets"),this.load.image("gameBg","game/sky.png"),this.load.image("logo","logo.png"),this.load.image("bgTile","game/GrassCliffMid.png"),this.load.image("saw","game/Saw.png"),this.load.image("brick_tile","game/brick_tile.png"),this.load.image("slingshot_bottom","game/slingshotPoint.png")}create(){this.scene.start("MainMenu")}}const F={type:n.AUTO,width:a,height:r,parent:"game-container",backgroundColor:"#028af8",physics:{default:"matter",matter:{gravity:{y:1,x:0},debug:!0}},scene:[o,V,L,T,i],scale:{mode:Phaser.Scale.NONE,autoCenter:Phaser.Scale.NO_CENTER}};document.addEventListener("DOMContentLoaded",(()=>{(()=>{const e=new n.Game({...F,parent:"game-container"});e.scale.resize(window.innerWidth,window.innerHeight),window.addEventListener("resize",(()=>{e.scale.resize(window.innerWidth,window.innerHeight)}))})()}));
