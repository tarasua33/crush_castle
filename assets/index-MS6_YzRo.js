var t=Object.defineProperty,e=(e,s,n)=>((e,s,n)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n)(e,"symbol"!=typeof s?s+"":s,n);import{r as s}from"./phaser-UvlxNa5i.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();var n=s();class o extends n.Scene{constructor(){super("Boot")}preload(){this.load.image("background","assets/bg.png")}create(){this.scene.start("Preloader")}}class i extends n.Scene{constructor(){super("GameOver"),e(this,"camera"),e(this,"background"),e(this,"gameover_text")}create(){this.camera=this.cameras.main,this.camera.setBackgroundColor(16711680),this.background=this.add.image(512,384,"background"),this.background.setAlpha(.5),this.gameover_text=this.add.text(512,384,"Game Over",{fontFamily:"Arial Black",fontSize:64,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}),this.gameover_text.setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("MainMenu")}))}}const a=2048,r=1536,p=150,c=1044.4,l=400;class h{constructor(){e(this,"_models"),this._models={}}}class m extends h{}class d extends m{buildUi({scene:t}){const e=t.matter.add.image(l,c,"saw").setCircle(60).setBounce(.4);return e.setFrictionAir(.03),e.setScale(.5),e}}class _ extends m{buildUi({scene:t}){const e=t.cache.json.get("castles"),s=[];for(const n of e){const e=t.matter.add.image(1433.6+n.x,1254.4+n.y,"brick_tile",void 0,{label:"block"}).setBody({type:"rectangle",width:48,height:16});e.rotation=n.rotation,console.log(e.y),s.push(e)}return s}}class g extends m{buildUi({scene:t}){const e=t.add.image(1024,768,"gameBg");return e.setScale(2),e.setOrigin(.5),e}}class u extends m{buildUi({scene:t}){const e=t.add.tileSprite(1024,1318.4,4096,128,"bgTile");return e.setOrigin(.5),t.matter.add.gameObject(e,{isStatic:!0,label:"ground"}),console.log("ground",e.y-e.height/2),e}}class S extends Phaser.GameObjects.Container{constructor(){super(...arguments),e(this,"_slingshotPoint"),e(this,"_rope"),e(this,"_baseRopeHeight")}build(t){const{scene:e,topPart:s,bottomPart:n,slingshotPointConfig:o,ropeConfig:i}=t,a=new Phaser.GameObjects.Image(e,s.x,s.y,s.texture);a.setOrigin(s.anchor.x,s.anchor.y),a.setScale(s.scaleX||1,s.scaleY||1),this.add(a);const r=new Phaser.GameObjects.Image(e,n.x,a.height,n.texture);r.setOrigin(n.anchor.x,n.anchor.y),r.setScale(n.scaleX||1,n.scaleY||1),this.add(r);const p=this._rope=new Phaser.GameObjects.Image(e,i.x,i.y,i.texture);p.setOrigin(i.anchor.x,i.anchor.y),this._baseRopeHeight=p.height||1,p.setScale(i.scaleX||1,i.scaleY||1),this.add(p),(this._slingshotPoint=e.matter.add.image(o.x,o.y,o.texture,"",{isStatic:!0,isSensor:!0,render:{visible:!0}})).setScale(o.scaleX||1,o.scaleY||1)}get slingshotPoint(){return this._slingshotPoint}rotateSlingshotPoint(t){this._slingshotPoint.angle=3*t}rotateRope(t,e){const s=this._rope;s.angle=Phaser.Math.RadToDeg(t)-90;const n=e/this._baseRopeHeight;s.setScale(1,n)}}class C extends m{buildUi({scene:t}){const e=new S(t,l,c);return t.add.existing(e),e.build({scene:t,topPart:{texture:"slingshot_top",x:0,y:0,anchor:{x:.5,y:0}},bottomPart:{texture:"slingshot_bottom",x:0,y:0,anchor:{x:.5,y:0},scaleY:3.7},ropeConfig:{texture:"rope",x:0,y:0,anchor:{x:.5,y:0},scaleY:0},slingshotPointConfig:{texture:"slingshotPoint_point",x:l,y:c,anchor:{x:.5,y:.5},scaleX:2,scaleY:2}}),e}}class w extends h{buildUi(t){const{scene:e}=t,s=new u,n=new d,o=new C,i=new _;return{bg:(new g).buildUi({scene:e}),ground:s.buildUi({scene:e}),bullet:n.buildUi({scene:e}),slingshotPoint:o.buildUi({scene:e}),bricks:i.buildUi({scene:e})}}}const y="COMPLETE";class f{constructor(){e(this,"completeStepSignal",new Phaser.Events.EventEmitter),e(this,"_params"),e(this,"_models"),this._models={}}_onComplete(...t){console.log("complete",this),this.completeStepSignal.emit(y,...t)}forceComplete(){}}class b extends f{}class P{constructor(){e(this,"completeSteps",new Phaser.Events.EventEmitter),e(this,"_sequences"),e(this,"_stepByStepSteps",[]),e(this,"_awaitSteps",[]),e(this,"_permanentsSteps",[]),e(this,"_dynamicSteps",new Set),e(this,"_numPermanentsSteps",0),e(this,"_numConsequentsSteps",0),e(this,"_isForceComplete",!1)}start(t){this._isForceComplete=!1,this._dynamicSteps.clear(),this._sequences=t,this._playNextSequence()}addDynamicStep(t,e){this._dynamicSteps.add(t),console.log("start",t),t.completeStepSignal.once(y,this._onCompleteDynamicStep,this),t.start(e)}_onCompleteDynamicStep(t){this._dynamicSteps.has(t)&&this._dynamicSteps.delete(t)}_playNextSequence(){const t=this._sequences;if(t&&t.length>0){const t=this._sequences.shift();this._setUpSequence(t)}else this._onComplete()}_setUpSequence(t){this._numPermanentsSteps=0,this._stepByStepSteps=t.stepByStep,this._permanentsSteps=t.permanents,this._awaitSteps=t.awaitSteps,this._numConsequentsSteps=t.stepByStep.length,t.permanents.length>0&&this._setUpPermanentsSteps(t.permanents),t.awaitSteps.length>0&&this._setUpAwaitSteps(t.awaitSteps),this._playNextConsequentStep()}_setUpPermanentsSteps(t){for(let e=0;e<t.length;e++){this._numPermanentsSteps++;const s=t[e].step,n=t[e].params;console.log("start",s),s.completeStepSignal.once(y,this._onPermanentStepComplete,this),s.start(n)}}_setUpAwaitSteps(t){for(let e=0;e<t.length;e++){const s=t[e].step,n=t[e].params;console.log("start",s),s.start(n)}}_onPermanentStepComplete(){this._numPermanentsSteps--,0===this._numPermanentsSteps&&this._tryCompleteSequence()}_playNextConsequentStep(){const t=this._stepByStepSteps;if(this._numConsequentsSteps>0){const e=t.length-this._numConsequentsSteps,s=t[e].step,n=t[e].params;console.log("start",s),s.completeStepSignal.once(y,this._onConsequentStepComplete,this),s.start(n)}else this._completeAwaitSteps(),this._tryCompleteSequence()}_completeAwaitSteps(){for(const{step:t}of this._awaitSteps)t.forceComplete();this._awaitSteps=[]}_onConsequentStepComplete(){this._isForceComplete||(this._numConsequentsSteps--,this._playNextConsequentStep())}_tryCompleteSequence(){this._isForceComplete||0===this._numPermanentsSteps&&0===this._numConsequentsSteps&&this._playNextSequence()}_onComplete(){this._sequences=[],this._stepByStepSteps=[],this._permanentsSteps=[],this._awaitSteps=[];for(const t of this._dynamicSteps)t.completeStepSignal.removeAllListeners(),t.forceComplete();this._dynamicSteps.clear(),this.completeSteps.emit(y)}forceComplete(){this._isForceComplete=!0;for(const t of this._stepByStepSteps)t.step.completeStepSignal.removeAllListeners(),t.step.forceComplete();for(const t of this._permanentsSteps)t.step.completeStepSignal.removeAllListeners(),t.step.forceComplete();for(const t of this._awaitSteps)t.step.completeStepSignal.removeAllListeners(),t.step.forceComplete();this._onComplete()}}class x extends f{constructor(){super(),e(this,"_mng",new P),this._mng.completeSteps.on(y,this._onComplete,this)}}class k{constructor(){e(this,"permanents",[]),e(this,"awaitSteps",[]),e(this,"stepByStep",[])}addPermanent(t,e){this.permanents.push({step:t,params:e})}addAwaitPermanentStep(t,e){this.awaitSteps.push({step:t,params:e})}addStepByStep(t,e){this.stepByStep.push({step:t,params:e})}}class v extends f{start(t){this._params=t;const{scene:e,delay:s}=t;e.time.delayedCall(s,this._onComplete,void 0,this)}}class U extends f{start(t){this._params=t;const{scene:e}=t;e.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){const{bullet:t,constraintComponent:e}=this._params,s=e.getPosition();t.setPosition(s.x,s.y)}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),this._worldUpdate(),super._onComplete()}forceComplete(){this._onComplete()}}class B extends f{start(t){this._params=t;const{scene:e}=t;e.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){const t=this._params.scene.matter.world.localWorld.bodies;let e=!1;for(const s of t)s.speed>.2&&(e=!0);e||this._onComplete()}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),super._onComplete()}}class D extends f{start(t){this._params=t;const{bullet:e,scene:s,duration:n}=t;s.camera.once("camerazoomcomplete",this._onComplete,this),s.camera.pan(e.x,e.y,n,"Sine.easeInOut"),s.zoomTo(1.2,n,"Sine.easeInOut")}_onComplete(){const{bullet:t,scene:e}=this._params;t.setAngularVelocity(-.5),e.camera.off("camerazoomcomplete",this._onComplete,this),e.camera.startFollow(t,!0,.1,.1),super._onComplete()}}class O extends f{start(t){this._params=t;const{bullet:e,scene:s}=t;e.setPosition(l,c),s.camera.stopFollow(),s.camera.once("camerazoomcomplete",this._onComplete,this),s.camera.pan(1024,768,500,"Sine.easeInOut"),s.zoomTo(1,500,"Sine.easeInOut")}_onComplete(){const{scene:t}=this._params;t.camera.off("camerazoomcomplete",this._onComplete,this),t.camera.centerOn(1024,768),super._onComplete()}}class M extends f{constructor(){super(...arguments),e(this,"_trashHold",3),e(this,"_previousDist",150)}start(t){this._params=t;const{scene:e,constraintComponent:s}=t;this._previousDist=160,t.scene.matter.world.removeConstraint(s.constraint),e.matter.world.on("afterupdate",this._worldUpdate,this)}_worldUpdate(){const{bullet:t}=this._params,e=this._params.slingshotPoint,s=this._params.slingshotPoint.slingshotPoint.body.position,n=Phaser.Math.Distance.Between(s.x,s.y,t.x,t.y),o=Math.atan2(t.y-s.y,t.x-s.x);this._params.bullet.body.speed&&this._params.bullet.body.speed>0&&(n<this._trashHold||n>this._previousDist)?(e.rotateSlingshotPoint(0),e.rotateRope(0,1),this._onComplete()):(e.rotateSlingshotPoint(n),e.rotateRope(o,n),this._previousDist=n)}_onComplete(){this._params.scene.matter.world.off("afterupdate",this._worldUpdate,this),super._onComplete()}}class q extends x{constructor(){super(...arguments),e(this,"_resetBulletStep",new O),e(this,"_endStrikeStep",new B),e(this,"_startStrikeStep",new M),e(this,"_awaitStep",new v),e(this,"_preparationStrikeStep",new D),e(this,"_awaitStrikeStep",new U)}start({gameView:t,scene:e,constraintComponent:s}){const n=new k;n.addAwaitPermanentStep(this._awaitStrikeStep,{scene:e,bullet:t.bullet,constraintComponent:s}),n.addStepByStep(this._preparationStrikeStep,{scene:e,bullet:t.bullet,duration:1e3});const o=new k;o.addStepByStep(this._startStrikeStep,{scene:e,bullet:t.bullet,constraintComponent:s,slingshotPoint:t.slingshotPoint}),o.addStepByStep(this._endStrikeStep,{scene:e}),o.addStepByStep(this._awaitStep,{scene:e,delay:2e3}),o.addStepByStep(this._resetBulletStep,{bullet:t.bullet,scene:e}),this._mng.start([n,o])}}class A extends f{constructor(){super(...arguments),e(this,"_pointerComponent")}start(t){this._params=t;const{scene:e,pointerComponent:s}=t;this._pointerComponent=s,e.input.on("pointerdown",this._startDrag,this)}_startDrag(t){const e=t.positionToCamera(this._params.scene.cameras.main),s=this._params.bullet;Phaser.Math.Distance.Between(e.x,e.y,s.x,s.y)<100&&(this._pointerComponent.pointer=e,this._pointerComponent.startDrag(),this._onComplete())}_onComplete(){this._params.scene.input.off("pointerdown",this._startDrag,this),super._onComplete()}}class z extends f{constructor(){super(...arguments),e(this,"_pointerComponent")}start(t){this._params=t;const{scene:e,pointerComponent:s}=t;this._pointerComponent=s,e.input.on("pointermove",this._onPointerMove,this),e.matter.world.on("afterupdate",this._onPhysicUpdate,this)}_onComplete(){const t=this._params.scene;t.input.off("pointermove",this._onPointerMove,this),t.matter.world.off("afterupdate",this._onPhysicUpdate,this),super._onComplete()}_onPhysicUpdate(){this._pointerComponent.isDragging&&this._pointerComponent.pointer&&this._onDrag(this._pointerComponent.pointer)}_onPointerMove(t){this._pointerComponent.isDragging&&(this._pointerComponent.pointer=t.positionToCamera(this._params.scene.cameras.main))}_onDrag(t){const e=t,s=this._params.slingshotPoint,n=this._params.slingshotPoint.slingshotPoint.body.position,{bullet:o,constraintComponent:i}=this._params,a=Phaser.Math.Distance.Between(n.x,n.y,e.x,e.y),r=Math.atan2(e.y-n.y,e.x-n.x);if(a<p)o.setPosition(e.x,e.y),i.setPosition(e.x,e.y),s.rotateSlingshotPoint(a),s.rotateRope(r,a);else{const t=Math.sin(r)*p,e=Math.cos(r)*p;o.setPosition(n.x+e,n.y+t),i.setPosition(n.x+e,n.y+t),s.rotateSlingshotPoint(p),s.rotateRope(r,p)}}forceComplete(){this._onComplete()}}class E extends f{constructor(){super(...arguments),e(this,"_pointerComponent")}start(t){this._params=t;const{scene:e,pointerComponent:s}=t;this._pointerComponent=s,e.input.on("pointerup",this._release,this)}_release(){if(this._pointerComponent.isDragging){const t=this._params.bullet;this._pointerComponent.endDrag(),this._pointerComponent.pointer=void 0;const e=t.body.velocity;t.setVelocity(Phaser.Math.Clamp(e.x,-50,50),Phaser.Math.Clamp(e.y,-50,50)),this._onComplete()}}_onComplete(){this._params.scene.input.off("pointerup",this._release,this),super._onComplete()}}class T extends x{constructor(){super(...arguments),e(this,"_awaitUserActionStep",new A),e(this,"_endDragStep",new E),e(this,"_dragActionStep",new z)}start({gameView:t,pointerComponent:e,constraintComponent:s,scene:n}){const o=new k;o.addStepByStep(this._awaitUserActionStep,{scene:n,bullet:t.bullet,pointerComponent:e});const i=new k;i.addAwaitPermanentStep(this._dragActionStep,{scene:n,bullet:t.bullet,slingshotPoint:t.slingshotPoint,pointerComponent:e,constraintComponent:s}),i.addStepByStep(this._endDragStep,{scene:n,bullet:t.bullet,pointerComponent:e}),this._mng.start([o,i])}}class N extends b{constructor(){super(...arguments),e(this,"_userActionController",new T),e(this,"_strikeController",new q)}start(t){this._params=t;const{gameView:e,pointerComponent:s,scene:n,constraintComponent:o}=t;o.createConstraint(e.bullet.body,e.slingshotPoint.slingshotPoint,n);const i=this._userActionController;i.completeStepSignal.once(y,this._playStrike,this),i.start({gameView:e,pointerComponent:s,constraintComponent:o,scene:n})}_playStrike(){this._strikeController.completeStepSignal.once(y,this._playResult,this);const{scene:t,gameView:e,constraintComponent:s}=this._params;this._strikeController.start({scene:t,gameView:e,constraintComponent:s})}_playResult(){const{gameView:t,pointerComponent:e,constraintComponent:s,scene:n}=this._params;s.createConstraint(t.bullet.body,t.slingshotPoint.slingshotPoint,n);const o=this._userActionController;o.completeStepSignal.once(y,this._playStrike,this),o.start({gameView:t,pointerComponent:e,constraintComponent:s,scene:n})}}class G{constructor(){e(this,"pointer"),e(this,"_isDragging",!1)}startDrag(){this._isDragging=!0}endDrag(){this._isDragging=!1}get isDragging(){return this._isDragging}}class L{constructor(){e(this,"_constraint"),e(this,"_pos")}createConstraint(t,e,s){return this._constraint=s.matter.add.constraint(t,e,0,.02),this._constraint}setPosition(t,e){this._pos=new Phaser.Math.Vector2(t,e)}getPosition(){return this._pos}get constraint(){return this._constraint}pauseUpdate(){}}class R extends n.Scene{constructor(){super("Game"),e(this,"camera"),e(this,"_scale",1)}create(){this.camera=this.cameras.main,this.scale.on("resize",this.resize,this),this.resize({width:window.innerWidth,height:window.innerHeight}),this.add.rectangle(0,0,a,r,16777215).setOrigin(0),this._createGame()}_createGame(){this.matter.world.setBounds(0,0,a,r);const t=(new w).buildUi({scene:this}),e=new L,s=new G;(new N).start({gameView:t,pointerComponent:s,constraintComponent:e,scene:this})}resize(t){const{width:e,height:s}=t,n=e,o=s,i=a,p=r,c=this._scale=Math.min(n/i,o/p);this.cameras.main.setZoom(c),this.cameras.main.centerOn(1024,768)}zoomTo(t,e,s){this.camera.zoomTo(this._scale*t,e,s)}}class V extends n.Scene{constructor(){super("MainMenu"),e(this,"background"),e(this,"logo"),e(this,"title")}create(){this.background=this.add.image(512,384,"background"),this.logo=this.add.image(512,300,"logo"),this.title=this.add.text(512,460,"Main Menu",{fontFamily:"Arial Black",fontSize:38,color:"#ffffff",stroke:"#000000",strokeThickness:8,align:"center"}).setOrigin(.5),this.input.once("pointerdown",(()=>{this.scene.start("Game")}))}}class j extends n.Scene{constructor(){super("Preloader")}init(){this.add.image(512,384,"background"),this.add.rectangle(512,384,468,32).setStrokeStyle(1,16777215);const t=this.add.rectangle(282,384,4,28,16777215);this.load.on("progress",(e=>{t.width=4+460*e}))}preload(){this.load.json("castles","data/castles.json"),this.load.setPath("assets"),this.load.image("gameBg","game/sky.png"),this.load.image("logo","logo.png"),this.load.image("bgTile","game/GrassCliffMid.png"),this.load.image("saw","game/Saw.png"),this.load.image("brick_tile","game/brick_tile.png"),this.load.image("slingshot_bottom","game/slingshotPoint_b.png"),this.load.image("slingshot_top","game/slingshotPoint_t.png"),this.load.image("slingshotPoint_point","game/slingshotPoint_point.png"),this.load.image("rope","game/rope.png")}create(){this.scene.start("MainMenu")}}const F={type:n.AUTO,width:a,height:r,parent:"game-container",backgroundColor:"#028af8",physics:{default:"matter",matter:{gravity:{y:1,x:0},debug:!0}},scene:[o,j,V,R,i],scale:{mode:Phaser.Scale.NONE,autoCenter:Phaser.Scale.NO_CENTER}};document.addEventListener("DOMContentLoaded",(()=>{(()=>{const t=new n.Game({...F,parent:"game-container"});t.scale.resize(window.innerWidth,window.innerHeight),window.addEventListener("resize",(()=>{t.scale.resize(window.innerWidth,window.innerHeight)}))})()}));
